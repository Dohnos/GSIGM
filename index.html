<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sigma Fantasy</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/png" href="https://i.postimg.cc/d18PNVwv/Icon.png" sizes="32x32">
<link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/d18PNVwv/Icon.png">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
:root{
  --primary:#004b87;--primary-light:#0d6efd;--primary-dark:#002244;
  --secondary:#f39c12;--secondary-light:#fbbf24;
  --sigma-bg-image:url('https://sigmafotbal.cz/assets/images/academy-bg.webp');
  --bg-body:linear-gradient(rgba(2,10,20,.55),rgba(2,10,20,.55)),var(--sigma-bg-image) center/cover no-repeat fixed;--card-bg:#fff;--text-main:#1e293b;--text-muted:#64748b;
  --pitch-grass:#238c26;--pitch-lines:rgba(255,255,255,.55);
  --danger:#ef4444;--success:#10b981;--info:#3b82f6;--warning:#f59e0b;
  --radius:20px;--shadow:0 10px 30px rgba(0,0,0,.06);
  --transition:.3s cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:Poppins,sans-serif;background:var(--bg-body);color:var(--text-main);overflow-x:hidden;line-height:1.6}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}

/* HERO */
#section-hero{min-height:100vh;background:var(--bg-body);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:3rem 1.5rem;position:relative;overflow:hidden}
.hero-particles{position:absolute;top:0;left:0;width:200%;height:200%;opacity:.12;background-image:radial-gradient(#fff 1px,transparent 1px);background-size:40px 40px;animation:floatBg 60s linear infinite}
@keyframes floatBg{from{background-position:0 0}to{background-position:400px 400px}}
.hero-glow{position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(243,156,18,.12),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
.animated-logo{width:120px;height:120px;margin-bottom:1.5rem;animation:bounceSpin 3s ease-in-out infinite;filter:drop-shadow(0 20px 25px rgba(0,0,0,.5));object-fit:contain}
@media (prefers-reduced-motion: reduce){.animated-logo{animation:none}}
@keyframes bounceSpin{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-35px) rotate(180deg)}}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);padding:8px 20px;border-radius:50px;border:1px solid rgba(255,255,255,.2);font-size:.85rem;font-weight:600;margin-bottom:1rem;color:#fbbf24}
.hero-title{font-size:clamp(2.5rem,6vw,4rem);font-weight:900;text-transform:uppercase;letter-spacing:3px;text-shadow:0 5px 20px rgba(0,0,0,.5);line-height:1.1}
.hero-title span{color:var(--secondary);display:block;font-size:.55em;letter-spacing:6px}
.hero-subtitle{font-size:1.05rem;color:#94a3b8;max-width:600px;margin:15px 0 35px}
.features-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:16px;max-width:900px;margin-bottom:3rem;z-index:10}
.feature-item{background:rgba(255,255,255,.07);backdrop-filter:blur(15px);padding:24px 20px;border-radius:20px;border:1px solid rgba(255,255,255,.12);flex:1;min-width:240px;transition:var(--transition)}
.feature-item:hover{transform:translateY(-5px);background:rgba(255,255,255,.12)}
.feature-icon{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:1.3rem}
.feature-item:nth-child(1) .feature-icon{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
.feature-item:nth-child(2) .feature-icon{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.feature-item:nth-child(3) .feature-icon{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.feature-item h3{margin:0 0 5px;font-size:1rem}.feature-item p{margin:0;font-size:.85rem;color:#94a3b8}
.cta-group{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;z-index:10}
.btn-cta{background:linear-gradient(135deg,var(--secondary),#e67e22);color:#fff;border:none;padding:18px 42px;border-radius:50px;font-size:1.15rem;font-weight:800;cursor:pointer;text-transform:uppercase;box-shadow:0 10px 30px rgba(243,156,18,.35);transition:var(--transition);font-family:Poppins;letter-spacing:1px}
.btn-cta:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 15px 40px rgba(243,156,18,.5)}
.btn-cta.outline{background:transparent;border:2px solid rgba(255,255,255,.4);box-shadow:none;color:#fff}
.btn-cta.outline:hover{background:rgba(255,255,255,.1);border-color:#fff}
.hero-stats{display:flex;gap:40px;margin-top:3rem;z-index:10}
.hero-stat{text-align:center}.hero-stat .num{font-size:2rem;font-weight:900;color:var(--secondary)}.hero-stat .label{font-size:.8rem;color:#94a3b8;text-transform:uppercase;letter-spacing:1px}

/* AUTH */
#section-auth{display:none;align-items:center;justify-content:center;min-height:100vh;padding:2rem 1rem;background:var(--bg-body)}
.auth-card{background:#fff;padding:3rem 2rem;border-radius:28px;box-shadow:0 25px 50px rgba(0,0,0,.08);width:100%;max-width:440px;text-align:center;border:1px solid #e2e8f0;position:relative;overflow:hidden}
.auth-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--primary))}
.auth-tabs{display:flex;background:#f1f5f9;border-radius:16px;padding:5px;margin-bottom:2rem}
.auth-tab{flex:1;padding:12px;border-radius:12px;font-weight:700;color:var(--text-muted);cursor:pointer;transition:var(--transition);font-size:.95rem}
.auth-tab.active{background:#fff;color:var(--primary);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.auth-form{display:none}.auth-form.active{display:block;animation:fadeSlideUp .5s ease}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
.auth-form h2{font-size:1.5rem;margin-bottom:1.5rem;color:var(--primary)}
.reg-input{width:100%;padding:15px 18px;border:2px solid #e2e8f0;border-radius:14px;font-family:Poppins;font-size:.95rem;margin-bottom:1rem;background:#f8fafc;outline:none;transition:var(--transition);color:var(--text-main)}
.reg-input:focus{border-color:var(--primary);background:#fff;box-shadow:0 0 0 4px rgba(0,75,135,.08)}
.reg-input:disabled{opacity:1;cursor:default;background:#f1f5f9;color:var(--text-main)}
.auth-back{display:inline-flex;align-items:center;gap:8px;margin-top:1.5rem;color:var(--text-muted);font-weight:600;cursor:pointer;font-size:.9rem;transition:var(--transition)}
.auth-back:hover{color:var(--primary)}

/* APP */
#section-app{display:none;opacity:0;transition:opacity .6s ease;padding-bottom:2rem}
#section-app.active{display:block;opacity:1}
.app-header{background:linear-gradient(135deg,#001529,var(--primary),#0066aa);color:#fff;padding:1.2rem 1.5rem 1.4rem;border-bottom-left-radius:28px;border-bottom-right-radius:28px;box-shadow:0 12px 30px rgba(0,75,135,.25);margin-bottom:2rem;position:sticky;top:0;z-index:100}
.header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
.header-left h1{margin:0;font-size:1.4rem;display:flex;align-items:center;gap:10px}.header-left h1 i{color:var(--secondary)}
.sigma-logo{width:80px;height:80px;object-fit:contain;filter:drop-shadow(0 10px 18px rgba(0,0,0,.35))}
.sigma-logo.small{width:36px;height:36px}
.header-left p{margin:4px 0 0;font-size:.85rem;color:#94a3b8;font-weight:500}
.header-right{cursor:pointer;display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.1);padding:8px 18px;border-radius:50px;border:1px solid rgba(255,255,255,.15);transition:var(--transition)}
.header-right:hover{background:rgba(255,255,255,.2)}
.header-pts{font-weight:800;font-size:1rem}.header-avatar{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.5)}
.container{max-width:1200px;margin:0 auto;padding:0 1rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
@media(max-width:950px){.container{grid-template-columns:1fr;gap:1.5rem}}
.card{background:#fff;border-radius:24px;padding:1.8rem;box-shadow:var(--shadow);border:1px solid #e8edf5;transition:var(--transition)}
.card:hover{box-shadow:0 15px 40px rgba(0,0,0,.08)}
.card-title{font-size:1.2rem;font-weight:800;margin:0 0 1.2rem;color:var(--primary);display:flex;align-items:center;gap:10px}

/* MATCH WIDGET */
.match-widget{background:linear-gradient(135deg,#001529,#003366,#004d99);border-radius:20px;padding:24px 20px;color:#fff;position:relative;overflow:hidden;margin-bottom:1.2rem}
.match-widget::before{content:'';position:absolute;top:-50%;right:-30%;width:300px;height:300px;background:radial-gradient(circle,rgba(243,156,18,.12),transparent 70%);pointer-events:none}
.match-league{text-align:center;font-size:.7rem;color:#94a3b8;text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:14px}
.match-league i{color:var(--secondary);margin-right:4px}
.match-teams{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:14px;position:relative;z-index:2}
.match-team{text-align:center;flex:1}
.team-logo{width:60px;height:60px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin:0 auto 8px;box-shadow:0 8px 20px rgba(0,0,0,.3);font-weight:900;overflow:hidden}
.team-logo img{width:100%;height:100%;object-fit:contain;padding:6px}
.team-home .team-logo{background:rgba(255,255,255,.95)}
.team-away .team-logo{background:linear-gradient(135deg,#1e293b,#475569);color:#fff}
.team-name{font-weight:700;font-size:.85rem}
.match-vs{font-size:1.6rem;font-weight:900;color:rgba(255,255,255,.25);text-transform:uppercase}
.match-countdown{text-align:center;position:relative;z-index:2}
.countdown-label{font-size:.7rem;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600}
.countdown-boxes{display:flex;justify-content:center;gap:8px}
.countdown-box{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px;min-width:54px;text-align:center}
.countdown-box .num{font-size:1.3rem;font-weight:900;display:block;line-height:1}.countdown-box .unit{font-size:.6rem;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-top:2px;display:block}
.match-status-bar{display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;position:relative;z-index:2}
.status-pill{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:50px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.status-pill.open{background:rgba(16,185,129,.15);color:#6ee7b7;border:1px solid rgba(16,185,129,.3)}
.status-pill.locked{background:rgba(239,68,68,.15);color:#fca5a5;border:1px solid rgba(239,68,68,.3)}
.status-pill.waiting{background:rgba(251,191,36,.15);color:#fcd34d;border:1px solid rgba(251,191,36,.3)}
.status-pill.live{background:rgba(239,68,68,.15);color:#fca5a5;border:1px solid rgba(239,68,68,.3);animation:pulseLive 2s infinite}
@keyframes pulseLive{0%,100%{opacity:1}50%{opacity:.6}}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.status-dot.green{background:#10b981;box-shadow:0 0 8px #10b981}
.status-dot.red{background:#ef4444;box-shadow:0 0 8px #ef4444;animation:pulseDot 1.5s infinite}
.status-dot.yellow{background:#fbbf24;box-shadow:0 0 8px #fbbf24;animation:pulseDot 2s infinite}
@keyframes pulseDot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* PHASE BANNER */
.phase-banner{padding:14px 18px;border-radius:14px;display:flex;align-items:center;gap:12px;margin-bottom:1.2rem;font-size:.85rem;font-weight:600}
.phase-banner i{font-size:1.2rem;flex-shrink:0}
.phase-banner.phase-open{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
.phase-banner.phase-lineup-locked{background:#fef3c7;border:1px solid #fde68a;color:#92400e}
.phase-banner.phase-all-locked{background:#fee2e2;border:1px solid #fecaca;color:#991b1b}
.phase-banner.phase-waiting{background:#fef3c7;border:1px solid #fde68a;color:#92400e}
.phase-banner.phase-evaluated{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}

/* LEGEND */
.legend-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;padding:16px;margin-bottom:1.2rem}
.legend-box h4{margin:0 0 10px;font-size:.85rem;color:var(--primary);display:flex;align-items:center;gap:8px}
.legend-items{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.legend-item{display:flex;align-items:center;gap:8px;font-size:.78rem;color:var(--text-muted);padding:4px 0}
.legend-item .l-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0;font-weight:800}
.legend-item .l-pts{font-weight:800;color:var(--primary);min-width:30px}
@media(max-width:500px){.legend-items{grid-template-columns:1fr}}

/* EVALUATION CARD */
.eval-card{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:2px solid #86efac;border-radius:20px;padding:24px;text-align:center;margin-bottom:1.2rem;display:none}
.eval-card.show{display:block;animation:fadeSlideUp .6s ease}
.eval-card h3{color:#065f46;margin:0 0 8px;font-size:1.2rem}
.eval-card .eval-pts{font-size:2.5rem;font-weight:900;color:var(--success)}
.eval-breakdown{margin-top:14px;text-align:left}
.eval-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #d1fae5;font-size:.85rem}
.eval-row:last-child{border:none}
.eval-row .pts{color:var(--success);font-weight:800}

/* FORMATION */
.formation-tabs{display:flex;gap:5px;background:#f1f5f9;padding:5px;border-radius:14px;margin-bottom:1rem}
.form-btn{flex:1;border:none;padding:10px 8px;border-radius:10px;font-weight:700;color:var(--text-muted);background:transparent;cursor:pointer;transition:var(--transition);font-size:.82rem;font-family:Poppins}
.form-btn.active{background:#fff;color:var(--primary);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.form-btn:hover:not(.active){background:rgba(0,75,135,.05)}
.form-btn:disabled{opacity:1;cursor:default;pointer-events:none}

/* PITCH */
.pitch-wrapper{display:flex;justify-content:center;margin-top:.5rem}
.pitch{width:100%;max-width:380px;aspect-ratio:2/3.2;background:repeating-linear-gradient(0deg,#1f8c24 0%,#1f8c24 10%,#23a028 10%,#23a028 20%);border:3px solid rgba(255,255,255,.7);border-radius:16px;position:relative;box-shadow:inset 0 0 60px rgba(0,0,0,.25),0 20px 40px rgba(0,0,0,.12);overflow:hidden}
.pitch::before{content:'';position:absolute;top:50%;left:0;width:100%;height:2px;background:var(--pitch-lines);transform:translateY(-50%)}
.pitch::after{content:'';position:absolute;top:50%;left:50%;width:70px;height:70px;border:2px solid var(--pitch-lines);border-radius:50%;transform:translate(-50%,-50%)}
.pitch-center-dot{position:absolute;top:50%;left:50%;width:8px;height:8px;background:var(--pitch-lines);border-radius:50%;transform:translate(-50%,-50%);z-index:2}
.penalty-box-top,.penalty-box-bottom{position:absolute;left:50%;transform:translateX(-50%);width:50%;height:15%;border:2px solid var(--pitch-lines)}
.penalty-box-top{top:0;border-top:none}.penalty-box-bottom{bottom:0;border-bottom:none}
.goal-box-top,.goal-box-bottom{position:absolute;left:50%;transform:translateX(-50%);width:25%;height:6%;border:2px solid var(--pitch-lines)}
.goal-box-top{top:0;border-top:none}.goal-box-bottom{bottom:0;border-bottom:none}
.slot{position:absolute;width:50px;height:50px;border-radius:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.4s cubic-bezier(.34,1.56,.64,1);z-index:10}
.slot:hover{transform:translate(-50%,-50%) scale(1.18);z-index:20}
.slot.empty{background:rgba(255,255,255,.92);border:2.5px dashed rgba(0,75,135,.6);color:var(--primary);animation:pulseSlot 2.5s ease-in-out infinite}
@keyframes pulseSlot{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.5)}50%{box-shadow:0 0 0 12px rgba(255,255,255,0)}}
.slot.filled{border:3px solid #fff;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.35)}
.slot.disabled{cursor:default;opacity:1}.slot.disabled:hover{transform:translate(-50%,-50%) scale(1)}
.slot img{width:100%;height:100%;border-radius:50%;object-fit:cover;object-position:top}
.player-name-tag{position:absolute;bottom:-20px;background:rgba(15,23,42,.85);color:#fff;font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:8px;white-space:nowrap;pointer-events:none}
.tip-badge{position:absolute;top:-6px;right:-6px;background:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7rem;box-shadow:0 4px 10px rgba(0,0,0,.25);border:2px solid var(--secondary);z-index:15}

/* GOALS SELECTOR */
.goals-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
.goal-chip{padding:14px 0;border-radius:14px;text-align:center;font-weight:800;font-size:1.1rem;cursor:pointer;border:2px solid #e2e8f0;background:#f8fafc;transition:var(--transition);color:var(--text-muted)}
.goal-chip:hover{border-color:var(--primary);background:#eff6ff;color:var(--primary)}
.goal-chip.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 6px 16px rgba(0,75,135,.3);transform:scale(1.05)}
.goal-chip:disabled,.goal-chip.disabled{opacity:1;cursor:default;pointer-events:none}
.goal-chip.disabled.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* SCORE PREDICTOR */
.score-predictor{display:flex;align-items:center;justify-content:center;gap:16px;padding:20px;background:#f8fafc;border-radius:16px;border:1px solid #e2e8f0;margin-top:8px}
.score-team{text-align:center;flex:1}
.score-team-logo{width:34px;height:34px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center}
.score-team-logo img{width:100%;height:100%;object-fit:contain}
.score-team label{display:block;font-weight:700;font-size:.8rem;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase}
.score-input{width:70px;height:70px;border:3px solid #e2e8f0;border-radius:16px;font-size:2rem;font-weight:900;text-align:center;font-family:Poppins;background:#fff;color:var(--primary);outline:none;transition:var(--transition)}
.score-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,75,135,.1)}
.score-input:disabled{opacity:1;cursor:default;background:#f1f5f9;color:var(--primary)}
.score-sep{font-size:2rem;font-weight:900;color:#cbd5e1}

/* FORMS */
.form-group{margin-bottom:1.3rem}
.form-group label{display:flex;justify-content:space-between;align-items:center;margin-bottom:.7rem;font-weight:700;font-size:.88rem}
.pts{color:var(--primary-light);font-size:.72rem;background:#eff6ff;padding:3px 8px;border-radius:8px;font-weight:700}
.visual-select-btn{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:14px;background:#f8fafc;display:flex;align-items:center;gap:12px;cursor:pointer;transition:var(--transition);font-family:Poppins}
.visual-select-btn:hover{border-color:var(--primary);background:#eff6ff}
.visual-select-btn.disabled{opacity:1;pointer-events:none;cursor:default}
.visual-select-btn img{width:42px;height:42px;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.1);border:2px solid #fff;object-fit:cover;object-position:top}
.icon-placeholder{width:42px;height:42px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:1.1rem;flex-shrink:0}
.vs-text{flex:1;font-weight:700;font-size:.95rem}.vs-pos{font-size:.72rem;color:#fff;background:var(--primary);padding:3px 8px;border-radius:8px;font-weight:600}
.btn-save{width:100%;padding:16px;background:linear-gradient(135deg,var(--success),#059669);color:#fff;border:none;border-radius:16px;font-size:1.05rem;font-weight:800;cursor:pointer;box-shadow:0 10px 25px rgba(16,185,129,.25);display:flex;justify-content:center;align-items:center;gap:10px;margin-top:.5rem;font-family:Poppins;transition:var(--transition);letter-spacing:.5px}
.btn-save:hover{transform:translateY(-2px);box-shadow:0 15px 35px rgba(16,185,129,.35)}
.btn-save:disabled{opacity:.5;cursor:not-allowed;transform:none!important}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:1rem}
.stat-card{background:linear-gradient(135deg,#f8fafc,#f1f5f9);border:1px solid #e2e8f0;border-radius:14px;padding:14px 10px;text-align:center;transition:var(--transition)}
.stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.06)}
.stat-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:.9rem}
.stat-card:nth-child(1) .stat-icon{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:var(--primary)}
.stat-card:nth-child(2) .stat-icon{background:linear-gradient(135deg,#fef3c7,#fde68a);color:#b45309}
.stat-card:nth-child(3) .stat-icon{background:linear-gradient(135deg,#d1fae5,#a7f3d0);color:#059669}
.stat-value{font-size:1.4rem;font-weight:900;line-height:1}.stat-label{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-top:3px}

/* MATCH HISTORY */
.match-history-title{font-size:.95rem;font-weight:800;color:var(--primary);margin:1.2rem 0 .8rem;display:flex;align-items:center;gap:8px}
.match-history-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:14px 16px;margin-bottom:8px;transition:var(--transition)}
.match-history-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.05)}
.mh-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.mh-match{font-weight:700;font-size:.9rem}.mh-pts{font-weight:900;color:var(--success);font-size:1rem;background:#dcfce7;padding:3px 10px;border-radius:10px}
.mh-pts.zero{color:var(--text-muted);background:#f1f5f9}
.mh-round{font-size:.72rem;color:var(--text-muted);font-weight:600}
.mh-breakdown{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px}
.mh-tag{font-size:.7rem;font-weight:700;padding:3px 8px;border-radius:8px;background:#eff6ff;color:var(--primary);border:1px solid #dbeafe}
.mh-empty{text-align:center;color:var(--text-muted);font-size:.85rem;padding:20px 0}

/* LEADERBOARD */
.lb-item{display:flex;align-items:center;gap:12px;padding:11px 14px;background:#f8fafc;border-radius:14px;margin-bottom:8px;border:1px solid #e2e8f0;cursor:pointer;transition:var(--transition)}
.lb-item:hover{transform:translateX(6px);border-color:var(--primary-light);background:#fff;box-shadow:0 5px 15px rgba(0,0,0,.04)}
.lb-item.is-me{background:linear-gradient(135deg,#eff6ff,#dbeafe);border-color:var(--primary-light)}
.lb-rank{font-weight:900;min-width:28px;text-align:center;color:var(--text-muted);font-size:1rem}
.lb-rank.gold{color:#f59e0b}.lb-rank.silver{color:#94a3b8}.lb-rank.bronze{color:#cd7f32}
.lb-item img{width:38px;height:38px;border-radius:50%;border:2px solid #e2e8f0;object-fit:cover;object-position:top}
.lb-name{flex:1;font-weight:700;font-size:.9rem}.lb-pts{font-weight:900;color:var(--primary);font-size:.95rem}
.btn-outline{width:100%;padding:13px;border:2px solid #e2e8f0;background:transparent;color:var(--text-muted);font-weight:700;font-size:.9rem;border-radius:14px;cursor:pointer;transition:var(--transition);margin-top:8px;font-family:Poppins;display:flex;justify-content:center;align-items:center;gap:8px}
.btn-outline:hover{border-color:var(--primary);color:var(--primary);background:#f0f7ff}

/* ADMIN MATCH LIST */
.admin-match-item{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:14px;margin-bottom:8px;border:1px solid #e2e8f0}
.admin-match-item .match-text{flex:1;font-weight:700;font-size:.9rem}
.admin-match-item .match-meta{font-size:.75rem;color:var(--text-muted)}
.admin-match-actions{display:flex;gap:6px}
.admin-match-actions button{padding:8px 12px;border:none;border-radius:10px;font-family:Poppins;font-weight:700;font-size:.75rem;cursor:pointer;transition:var(--transition)}
.btn-sm-primary{background:var(--primary);color:#fff}.btn-sm-danger{background:#fee2e2;color:var(--danger)}
.btn-sm-success{background:#d1fae5;color:#065f46}

/* MODALS */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.55);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}
.modal-overlay.show{display:flex;opacity:1}
.modal-content{background:#fff;width:92%;max-width:460px;max-height:85vh;display:flex;flex-direction:column;border-radius:24px;box-shadow:0 25px 60px rgba(0,0,0,.25);transform:translateY(30px) scale(.95);transition:.4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden}
.modal-overlay.show .modal-content{transform:translateY(0) scale(1)}
@media(max-width:600px){.modal-overlay{align-items:flex-end}.modal-content{width:100%;border-radius:24px 24px 0 0;max-height:92vh;transform:translateY(100%) scale(1)}.modal-overlay.show .modal-content{transform:translateY(0) scale(1)}}
.modal-header{padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;background:#fafbfe}
.modal-header h3{margin:0;font-size:1.15rem;color:var(--primary)}
.close-btn{background:#f1f5f9;border:none;width:36px;height:36px;border-radius:50%;font-size:1rem;cursor:pointer;transition:var(--transition);color:var(--text-muted);display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:#e2e8f0;transform:rotate(90deg)}
.modal-body{padding:1.2rem 1.5rem 1.5rem;overflow-y:auto}
.player-item{display:flex;align-items:center;gap:12px;padding:11px;border-radius:14px;cursor:pointer;border:2px solid transparent;background:#f8fafc;margin-bottom:8px;transition:var(--transition)}
.player-item:hover{border-color:var(--primary-light);background:#fff;transform:translateX(4px)}
.player-item.selected{opacity:.4;pointer-events:none;filter:grayscale(1)}
.player-item img{width:42px;height:42px;border-radius:50%;border:2px solid #e2e8f0;object-fit:cover;object-position:top}
.player-info-container{flex:1;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.player-name{font-weight:700;font-size:.95rem}.player-pos-full{font-size:.68rem;color:#fff;background:var(--primary);padding:3px 7px;border-radius:8px;font-weight:700;text-transform:uppercase}
.action-grid{display:grid;gap:10px}
.action-btn{padding:14px 16px;border-radius:14px;border:none;font-family:Poppins;font-weight:800;font-size:.9rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:var(--transition)}
.action-btn:hover{transform:translateY(-2px)}.btn-goal{background:#fef3c7;color:#b45309;border:2px solid #fde68a}.btn-assist{background:#dcfce7;color:#166534;border:2px solid #bbf7d0}.btn-delete{background:#fee2e2;color:var(--danger);border:2px solid #fecaca}
.profile-header{text-align:center;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid #f1f5f9}
.profile-header img{width:85px;height:85px;border-radius:50%;border:4px solid var(--primary);margin-bottom:8px;box-shadow:0 10px 25px rgba(0,0,0,.12);object-fit:cover;object-position:top}
.profile-header h2{margin:0 0 4px;font-size:1.3rem}
.profile-stat{background:#f8fafc;padding:13px 14px;border-radius:14px;display:flex;align-items:center;gap:12px;margin-bottom:8px;border:1px solid #e2e8f0}
.profile-stat i{font-size:1.2rem;color:var(--primary);width:26px;text-align:center}
.profile-stat div span{display:block;font-size:.72rem;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.btn-logout{background:#fee2e2;color:var(--danger);border:none;padding:7px 14px;border-radius:10px;font-weight:700;cursor:pointer;display:none;font-family:Poppins;font-size:.8rem;transition:var(--transition)}
.btn-logout:hover{background:#fecaca}
.app-footer{max-width:1200px;margin:3rem auto 0;padding:2rem 1rem;text-align:center;color:var(--text-muted);font-size:.8rem;border-top:1px solid #e2e8f0}

/* Toast */
#toast{position:fixed;top:20px;left:50%;transform:translate(-50%,-100px);background:#1e293b;color:#fff;padding:13px 26px;border-radius:50px;font-weight:700;font-size:.9rem;display:flex;align-items:center;gap:10px;box-shadow:0 15px 35px rgba(0,0,0,.25);transition:transform .5s cubic-bezier(.175,.885,.32,1.275),opacity .5s ease;z-index:3000;opacity:0;pointer-events:none;white-space:nowrap;max-width:95%}
#toast.show{transform:translate(-50%,0);opacity:1}#toast.success{background:linear-gradient(135deg,#059669,#10b981)}#toast.error{background:linear-gradient(135deg,#dc2626,#ef4444)}#toast.info{background:linear-gradient(135deg,#2563eb,#3b82f6)}

/* LOADING */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:5000;flex-direction:column;gap:16px}
.loading-overlay.hidden{display:none}
.spinner{width:50px;height:50px;border:4px solid #e2e8f0;border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
  <div class="spinner"></div>
  <div style="font-weight:700;color:var(--primary)">Naƒç√≠t√°m Sigma Fantasy...</div>
</div>

<div id="toast"><i class="fa-solid fa-bell"></i><span id="toast-msg"></span></div>

<!-- HERO -->
<section id="section-hero">
  <div class="hero-particles"></div><div class="hero-glow"></div>
  <img class="animated-logo" data-sigma-logo alt="SK Sigma Olomouc logo">
  <div class="hero-badge"><i class="fa-solid fa-bolt"></i> Sez√≥na 2025/26</div>
  <h1 class="hero-title">Sigma Fantasy<span>Fan Edition</span></h1>
  <p class="hero-subtitle">Sestav sv≈Øj t√Ωm z hr√°ƒç≈Ø SK Sigma Olomouc, tipuj v√Ωsledky z√°pas≈Ø a bojuj o pozici v ≈æeb≈ô√≠ƒçku!</p>
  <div class="features-grid">
    <div class="feature-item"><div class="feature-icon"><i class="fa-solid fa-users-viewfinder"></i></div><h3>Sestav t√Ωm</h3><p>Vyber 11 hr√°ƒç≈Ø a zvol formaci.</p></div>
    <div class="feature-item"><div class="feature-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div><h3>Tipuj z√°pas</h3><p>Zvol st≈ôelce, sk√≥re, g√≥ly i n√°v≈°tƒõvnost.</p></div>
    <div class="feature-item"><div class="feature-icon"><i class="fa-solid fa-trophy"></i></div><h3>Sb√≠rej body</h3><p>Porovnej se s ostatn√≠mi fanou≈°ky!</p></div>
  </div>
  <div class="cta-group">
    <button class="btn-cta" onclick="openAuth('register')">Registrovat <i class="fa-solid fa-user-plus"></i></button>
    <button class="btn-cta outline" onclick="openAuth('login')">P≈ôihl√°sit <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
  </div>
  <div class="hero-stats">
    <div class="hero-stat"><div class="num" id="hero-users-count">0</div><div class="label">Hr√°ƒç≈Ø</div></div>
    <div class="hero-stat"><div class="num" id="hero-players-count">0</div><div class="label">Hr√°ƒç≈Ø Sigmy</div></div>
    <div class="hero-stat"><div class="num">‚àû</div><div class="label">Z√°bavy</div></div>
  </div>
</section>

<!-- AUTH -->
<section id="section-auth">
  <div class="auth-card">
    <div class="auth-tabs">
      <div class="auth-tab" id="tab-login" onclick="switchAuthTab('login')">P≈ôihl√°≈°en√≠</div>
      <div class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">Registrace</div>
    </div>
    <div id="form-login" class="auth-form">
      <h2>V√≠tej zpƒõt üëã</h2>
      <input type="text" id="login-name" class="reg-input" placeholder="P≈ôezd√≠vka">
      <input type="password" id="login-pin" class="reg-input" placeholder="PIN">
      <button class="btn-save" onclick="loginUser()"><i class="fa-solid fa-arrow-right-to-bracket"></i> P≈ôihl√°sit</button>
      <div class="auth-back" onclick="backToHero()"><i class="fa-solid fa-arrow-left"></i> Zpƒõt na √∫vod</div>
    </div>
    <div id="form-register" class="auth-form">
      <h2>Vytvo≈ô si profil ‚ú®</h2>
      <input type="text" id="reg-name" class="reg-input" placeholder="P≈ôezd√≠vka">
      <input type="password" id="reg-pin" class="reg-input" placeholder="PIN (min 4 znaky)">
      <input type="email" id="reg-email" class="reg-input" placeholder="E-mail" aria-label="Zadejte v√°≈° email">
      <input type="text" id="reg-city" class="reg-input" placeholder="Odkud fand√≠≈°? (min. 3 znaky)" list="reg-city-list" autocomplete="off" aria-label="Vyberte mƒõsto, odkud fand√≠te">
      <datalist id="reg-city-list"></datalist>
      <button type="button" id="reg-player-btn" class="reg-input" style="text-align:left;display:flex;align-items:center;gap:10px;cursor:pointer;background:#fff;" onclick="openRegPlayerSelect()">
        <img id="reg-player-img" src="" alt="Obl√≠ben√Ω hr√°ƒç" style="width:36px;height:48px;border-radius:8px;object-fit:cover;object-position:top;display:none;">
        <span id="reg-player-label" style="color:#94a3b8;">Obl√≠ben√Ω hr√°ƒç?</span>
      </button>
      <input type="hidden" id="reg-player" value="">
      <button class="btn-save" onclick="registerUser()"><i class="fa-solid fa-user-plus"></i> Registrovat</button>
      <div class="auth-back" onclick="backToHero()"><i class="fa-solid fa-arrow-left"></i> Zpƒõt na √∫vod</div>
    </div>
  </div>
</section>

<!-- APP -->
<section id="section-app">
  <div class="app-header">
    <div class="header-content">
      <div class="header-left"><h1><img class="sigma-logo small" data-sigma-logo alt="SK Sigma Olomouc logo"> Sigma Fantasy</h1><p id="user-welcome">V√≠tej</p></div>
      <div class="header-right" onclick="openProfile('me')"><span class="header-pts" id="user-top-pts">0 b</span><img class="header-avatar" id="user-top-avatar" src=""></div>
    </div>
  </div>

  <div class="container">
    <!-- LEFT -->
    <div style="display:flex;flex-direction:column;gap:2rem">
      <div class="card">
        <h2 class="card-title"><i class="fa-solid fa-clipboard-user"></i> Tvoje sestava</h2>

        <div class="match-widget" id="match-widget">
          <div class="match-league"><i class="fa-solid fa-futbol"></i> <span id="match-league-text">Chance Liga</span></div>
          <div class="match-teams">
            <div class="match-team team-home"><div class="team-logo"><img data-sigma-logo alt="SK Sigma Olomouc logo"></div><div class="team-name">Sigma Olomouc</div></div>
            <div class="match-vs">VS</div>
            <div class="match-team team-away"><div class="team-logo" id="away-logo">?</div><div class="team-name" id="away-name">???</div></div>
          </div>
          <div class="match-countdown" id="match-countdown">
            <div class="countdown-label" id="countdown-label">Do zaƒç√°tku z√°pasu</div>
            <div class="countdown-boxes">
              <div class="countdown-box"><span class="num" id="cd-days">0</span><span class="unit">dn√≠</span></div>
              <div class="countdown-box"><span class="num" id="cd-hours">0</span><span class="unit">hod</span></div>
              <div class="countdown-box"><span class="num" id="cd-mins">0</span><span class="unit">min</span></div>
              <div class="countdown-box"><span class="num" id="cd-secs">0</span><span class="unit">sek</span></div>
            </div>
          </div>
          <div class="match-status-bar" id="match-status-bar"></div>
        </div>

        <div class="phase-banner phase-open" id="phase-banner">
          <i class="fa-solid fa-circle-info"></i>
          <span id="phase-text">V≈°e je otev≈ôeno ‚Äî sestavuj a tipuj!</span>
        </div>

        <!-- EVALUATION CARD -->
        <div class="eval-card" id="eval-card">
          <h3>üéâ Vyhodnocen√≠ z√°pasu</h3>
          <div class="eval-pts" id="eval-total-pts">+0</div>
          <div style="font-size:.85rem;color:var(--text-muted);margin-top:4px">bod≈Ø za tento z√°pas</div>
          <div class="eval-breakdown" id="eval-breakdown"></div>
        </div>

        <div class="formation-tabs" id="formation-tabs">
          <button class="form-btn active" onclick="changeFormation('4-2-3-1')">4-2-3-1</button>
          <button class="form-btn" onclick="changeFormation('4-4-2')">4-4-2</button>
          <button class="form-btn" onclick="changeFormation('3-5-2')">3-5-2</button>
        </div>

        <div class="pitch-wrapper"><div class="pitch" id="pitch">
          <div class="pitch-center-dot"></div>
          <div class="penalty-box-top"></div><div class="penalty-box-bottom"></div>
          <div class="goal-box-top"></div><div class="goal-box-bottom"></div>
        </div></div>
      </div>

      <div class="card">
        <h2 class="card-title"><i class="fa-solid fa-chart-simple"></i> Tvoje statistiky</h2>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-star"></i></div><div class="stat-value" id="my-points">0</div><div class="stat-label">Body</div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-bullseye"></i></div><div class="stat-value" id="my-predictions">0</div><div class="stat-label">Predikc√≠</div></div>
          <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-ranking-star"></i></div><div class="stat-value" id="my-rank">-</div><div class="stat-label">Po≈ôad√≠</div></div>
        </div>
        <div class="match-history-title"><i class="fa-solid fa-clock-rotate-left"></i> Historie tip≈Ø</div>
        <div id="match-history-container"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div style="display:flex;flex-direction:column;gap:2rem">
      <div class="card" id="prediction-card">
        <h2 class="card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> Tipuj z√°pas</h2>

        <!-- LEGEND -->
        <div class="legend-box">
          <h4><i class="fa-solid fa-book-open"></i> Legenda bodov√°n√≠</h4>
          <div class="legend-items">
            <div class="legend-item"><div class="l-icon" style="background:#dcfce7;color:#166534">1</div><div>Kompletn√≠ sestava</div><div class="l-pts">+1b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#dbeafe;color:var(--primary)">‚öΩ</div><div>P≈ôesn√© sk√≥re</div><div class="l-pts">+10b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#fef3c7;color:#b45309">1X2</div><div>Spr√°vn√Ω tip (V/R/P)</div><div class="l-pts">+3b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#fce7f3;color:#be185d">üéØ</div><div>St≈ôelec 1. g√≥lu</div><div class="l-pts">+5b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#e0e7ff;color:#4338ca">#</div><div>Celkov√© g√≥ly</div><div class="l-pts">+3b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#fef3c7;color:#92400e">üë•</div><div>P≈ôesn√° n√°v≈°tƒõvnost</div><div class="l-pts">+5b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#ecfdf5;color:#065f46">¬±</div><div>N√°v≈°tƒõvnost ¬±1000</div><div class="l-pts">+2b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#dcfce7;color:#166534">‚öΩ</div><div>Tip: hr√°ƒç d√° g√≥l</div><div class="l-pts">+4b</div></div>
            <div class="legend-item"><div class="l-icon" style="background:#fef3c7;color:#b45309">üëü</div><div>Tip: hr√°ƒç asistence</div><div class="l-pts">+3b</div></div>
          </div>
        </div>

        <!-- SCORE PREDICTION -->
        <div class="form-group">
          <label>V√Ωsledek z√°pasu <span class="pts">P≈ôesnƒõ +10b / Tip +3b</span></label>
          <div class="score-predictor" id="score-predictor">
            <div class="score-team"><div class="score-team-logo"><img data-sigma-logo alt="SK Sigma Olomouc logo"></div><label>Sigma</label><input type="number" id="pred-score-home" class="score-input" min="0" max="20" placeholder="0" oninput="autoSave()"></div>
            <div class="score-sep">:</div>
            <div class="score-team"><label id="pred-away-label">Soupe≈ô</label><input type="number" id="pred-score-away" class="score-input" min="0" max="20" placeholder="0" oninput="autoSave()"></div>
          </div>
        </div>

        <!-- FIRST SCORER -->
        <div class="form-group">
          <label>St≈ôelec 1. g√≥lu <span class="pts">+5b</span></label>
          <div class="visual-select-btn" id="btn-scorer-select" onclick="openScorerSelectModal()">
            <div class="icon-placeholder"><i class="fa-solid fa-crosshairs"></i></div>
            <div class="vs-text" style="color:var(--text-muted)">Vyber st≈ôelce...</div>
          </div>
        </div>

        <!-- TOTAL GOALS -->
        <div class="form-group">
          <label>Celkov√Ω poƒçet g√≥l≈Ø <span class="pts">+3b</span></label>
          <div class="goals-grid" id="goals-grid"></div>
        </div>

        <!-- ATTENDANCE -->
        <div class="form-group">
          <label>N√°v≈°tƒõvnost <span class="pts">P≈ôesnƒõ +5b / ¬±1000 +2b</span></label>
          <input type="number" id="attendance" class="reg-input" placeholder="Nap≈ô. 6500" style="margin:0" oninput="autoSave()">
        </div>

        <button class="btn-save" id="btn-save-pred" onclick="savePrediction()"><i class="fa-solid fa-floppy-disk"></i> Ulo≈æit predikci</button>
      </div>

      <!-- LEADERBOARD -->
      <div class="card">
        <h2 class="card-title"><i class="fa-solid fa-trophy" style="color:var(--secondary)"></i> Top Tabulka</h2>
        <div id="leaderboard-container"></div>
        <button class="btn-outline" onclick="openFullLeaderboard()"><i class="fa-solid fa-list-ol"></i> Cel√° tabulka</button>
      </div>

      <!-- ADMIN -->
      <div class="card" id="admin-panel" style="display:none">
        <h2 class="card-title"><i class="fa-solid fa-user-shield"></i> Admin panel</h2>

        <!-- ADD MATCH -->
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;padding:16px;margin-bottom:1.2rem">
          <h4 style="margin:0 0 12px;font-size:.9rem;color:var(--primary)"><i class="fa-solid fa-plus-circle"></i> P≈ôidat z√°pas</h4>
          <input type="text" id="admin-new-opponent" class="reg-input" placeholder="Soupe≈ô (nap≈ô. Ban√≠k Ostrava)">
          <input type="text" id="admin-new-logo" class="reg-input" placeholder="Logo text (nap≈ô. B)">
          <input type="text" id="admin-new-round" class="reg-input" placeholder="Kolo (nap≈ô. Kolo 22)">
          <input type="datetime-local" id="admin-new-datetime" class="reg-input">
          <button class="btn-save" onclick="adminAddMatch()" style="background:var(--primary)"><i class="fa-solid fa-plus"></i> P≈ôidat z√°pas</button>
        </div>

        <!-- MATCH LIST -->
        <div style="margin-bottom:1.2rem">
          <h4 style="margin:0 0 10px;font-size:.9rem;color:var(--primary)"><i class="fa-solid fa-list"></i> Z√°pasy</h4>
          <div id="admin-match-list"></div>
        </div>

        <!-- EVALUATE -->
        <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:16px;padding:16px;margin-bottom:1rem">
          <h4 style="margin:0 0 12px;font-size:.9rem;color:#92400e"><i class="fa-solid fa-gavel"></i> Vyhodnotit aktu√°ln√≠ z√°pas</h4>
          <div class="form-group"><label>Sk√≥re</label>
            <div style="display:flex;gap:10px">
              <input type="number" id="admin-score-home" class="reg-input" placeholder="Sigma" style="flex:1">
              <input type="number" id="admin-score-away" class="reg-input" placeholder="Soupe≈ô" style="flex:1">
            </div>
          </div>
          <div class="form-group">
            <label>Prvn√≠ st≈ôelec</label>
            <div class="visual-select-btn" onclick="openAdminScorerSelect()">
              <div class="icon-placeholder"><i class="fa-solid fa-crosshairs"></i></div>
              <div class="vs-text" id="admin-scorer-label" style="color:var(--text-muted)">Vyber hr√°ƒçe...</div>
            </div>
          </div>
          <div class="form-group"><label>Celkov√© g√≥ly</label>
            <div class="goals-grid" id="admin-goals-grid"></div>
          </div>
          <div class="form-group"><label>N√°v≈°tƒõvnost</label><input type="number" id="admin-attendance" class="reg-input" placeholder="Nap≈ô. 7200"></div>
          <div class="form-group"><label>St≈ôelci</label><div id="admin-goal-list" style="display:flex;flex-wrap:wrap;gap:6px"></div></div>
          <div class="form-group"><label>Asistence</label><div id="admin-assist-list" style="display:flex;flex-wrap:wrap;gap:6px"></div></div>
          <button class="btn-save" style="background:var(--warning);color:#000" onclick="evaluateMatch()"><i class="fa-solid fa-gavel"></i> Vyhodnotit</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="app-footer">¬© 2026 Sigma Fantasy ‚Äî Fan Edition. Vytvo≈ôeno s ‚ù§Ô∏è pro fanou≈°ky SK Sigma Olomouc.</footer>
</section>

<!-- MODALS -->
<div class="modal-overlay" id="player-modal"><div class="modal-content">
  <div class="modal-header"><h3 id="modal-title">Vyber hr√°ƒçe</h3><button class="close-btn" onclick="closeModal('player-modal')"><i class="fa-solid fa-xmark"></i></button></div>
  <div class="modal-body" id="player-list"></div>
</div></div>

<div class="modal-overlay" id="action-modal"><div class="modal-content">
  <div class="modal-header"><h3>Akce hr√°ƒçe</h3><button class="close-btn" onclick="closeModal('action-modal')"><i class="fa-solid fa-xmark"></i></button></div>
  <div class="modal-body">
    <div style="text-align:center;margin-bottom:1.5rem">
      <img id="action-player-img" src="" style="width:clamp(80px,25vw,120px);height:clamp(80px,25vw,120px);border-radius:50%;border:3px solid var(--primary);box-shadow:0 8px 20px rgba(0,0,0,.15);object-fit:cover;object-position:top">
      <h2 id="action-player-name" style="margin:10px 0 2px;font-size:1.3rem"></h2>
      <div id="action-player-pos" style="color:var(--text-muted);font-weight:700;font-size:.85rem"></div>
    </div>
    <div class="action-grid">
      <button class="action-btn btn-goal" onclick="setPlayerTip('goal')"><span>‚öΩ Tip: D√° g√≥l</span><strong>+4b</strong></button>
      <button class="action-btn btn-assist" onclick="setPlayerTip('assist')"><span>üëü Tip: Asistence</span><strong>+3b</strong></button>
      <button class="action-btn" style="background:#f1f5f9;color:var(--text-muted);border:2px solid #e2e8f0" onclick="setPlayerTip(null)"><span>Zru≈°it tip</span><span></span></button>
      <button class="action-btn btn-delete" id="btn-remove-player" onclick="removePlayerFromPitch()"><span><i class="fa-solid fa-trash-can"></i> Odstranit</span><span></span></button>
    </div>
  </div>
</div></div>

<div class="modal-overlay" id="profile-modal" style="z-index:1100"><div class="modal-content">
  <div class="modal-header">
    <h3><i class="fa-solid fa-id-card"></i> Karta fanou≈°ka</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btn-logout" class="btn-logout" onclick="logoutUser()"><i class="fa-solid fa-right-from-bracket"></i> Odhl√°sit</button>
      <button class="close-btn" onclick="closeModal('profile-modal')"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>
  <div class="modal-body">
    <div class="profile-header"><img id="prof-img" src=""><h2 id="prof-name"></h2><div id="prof-pts" style="color:var(--primary);font-weight:900;font-size:1.1rem"></div></div>
    <div class="profile-stat"><i class="fa-solid fa-location-dot"></i><div><span>Odkud fand√≠</span><strong id="prof-city"></strong></div></div>
    <div class="profile-stat"><i class="fa-solid fa-star"></i><div><span>Obl√≠ben√Ω hr√°ƒç</span><strong id="prof-fav"></strong></div></div>
    <div class="profile-stat"><i class="fa-solid fa-ranking-star"></i><div><span>Pozice</span><strong id="prof-rank"></strong></div></div>
  </div>
</div></div>

<div class="modal-overlay" id="full-lb-modal" style="z-index:1100"><div class="modal-content">
  <div class="modal-header"><h3><i class="fa-solid fa-list-ol"></i> Celkov√© po≈ôad√≠</h3><button class="close-btn" onclick="closeModal('full-lb-modal')"><i class="fa-solid fa-xmark"></i></button></div>
  <div class="modal-body" id="full-lb-list"></div>
</div></div>

<script>
/* ============================================================
   üî• FIREBASE CONFIG ‚Äî NAHRAƒé SV√ùMI √öDAJI
   ============================================================ */
const sigmaLogoUrl="https://sigmafotbal.esports.cz/files/logos/SK%20SIGMA.png";
document.querySelectorAll('[data-sigma-logo]').forEach((img)=>{
  img.src=sigmaLogoUrl;
  img.onerror=()=>{img.style.display='none';};
});
const firebaseConfig = {
  apiKey: "AIzaSyANSwvhcNvpNDgEBSpGjgqxoOB_1nG389M",
  authDomain: "gsigm-a71ec.firebaseapp.com",
  databaseURL: "https://gsigm-a71ec-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "gsigm-a71ec",
  storageBucket: "gsigm-a71ec.firebasestorage.app",
  messagingSenderId: "696968685510",
  appId: "1:696968685510:web:c48733d5b3671bbda7b4c7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================================================
   DATA
   ============================================================ */
const getAvatar=(n)=>`https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=004b87&color=fff&bold=true&size=128`;
const fullPositions={B:'Brank√°≈ô',O:'Obr√°nce',Z:'Z√°lo≈æn√≠k',√ö:'√ötoƒçn√≠k'};
const players=[
  {id:1,name:"Diga≈àa Tom√°≈°",number:1,pos:"B",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/digana-tomas.png?1752651890"},
  {id:2,name:"Hru≈°ka Mat√∫≈°",number:98,pos:"B",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/hruska-matus.png?1752403611"},
  {id:3,name:"Koutn√Ω Jan",number:91,pos:"B",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/koutny-jan.png?1752403638"},
  {id:4,name:"Stoppen Tade√°≈°",number:29,pos:"B",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/stoppen-tadeas.png?1752403700"},
  {id:5,name:"Elbel Jakub",number:4,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/elbel-jakub.png?1752403598"},
  {id:6,name:"Hada≈° Matƒõj",number:22,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/hadas-matej.png?1752403607"},
  {id:7,name:"Kr√°l Jan",number:21,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/kral-jan.png?1752403642"},
  {id:8,name:"Lurvink Louis",number:3,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/lurvink-louis.png?1770906685"},
  {id:9,name:"Mal√Ω Mat√∫≈°",number:33,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/maly-matus.png?1752403656"},
  {id:10,name:"Sl√°ma Ji≈ô√≠",number:13,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/slama-jiri.png?1752403688"},
  {id:11,name:"Slav√≠ƒçek Filip",number:16,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/slavicek-filip.png?1752403692"},
  {id:12,name:"Sylla Abdoulaye",number:2,pos:"O",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/sylla-abdoulaye.png?1752403705"},
  {id:13,name:"Bar√°th P√©ter",number:88,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/barath-peter.png?1769590340"},
  {id:14,name:"Beran Michal",number:47,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/beran-michal.png?1757526996"},
  {id:15,name:"Dol≈ænikov Artur",number:77,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/dolznikov-artur.png?1752403589"},
  {id:16,name:"Ghali Ahmad",number:70,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/ghali-ahmad.png?1757526545"},
  {id:17,name:"Grgiƒá Dario",number:20,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/grgic-dario.png?1767999691"},
  {id:18,name:"Jano≈°ek Dominik",number:39,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/janosek-dominik.png?1752403624"},
  {id:19,name:"Jezierski Jakub",number:19,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/jezierski-jakub.png?1769590341"},
  {id:20,name:"Krivak Fabijan",number:23,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/krivak-fabijan.png?1768328499"},
  {id:21,name:"Sp√°ƒçil Ji≈ô√≠",number:8,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/spacil-jiri.png?1752403697"},
  {id:22,name:"≈†√≠p J√°chym",number:6,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/sip-jachym.png?1752403683"},
  {id:23,name:"≈†turm Danijel",number:7,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/sturm-danijel.png?1767999695"},
  {id:24,name:"Tk√°ƒç David",number:24,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/tkac-david.png?1752403709"},
  {id:25,name:"Uriƒça Filip",number:27,pos:"Z",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/urica-filip.png?1752403713"},
  {id:26,name:"Dembe John Paul",number:18,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/dembe-john-paul.png?1770906684"},
  {id:27,name:"Kliment Jan",number:9,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/kliment-jan.png?1752403629"},
  {id:28,name:"Mikulenka Matƒõj",number:25,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/mikulenka-matej.png?1752403660"},
  {id:29,name:"Muritala Yunusa",pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/muritala-yunusa.png?1752403665"},
  {id:30,name:"R≈Øsek Anton√≠n",number:14,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/rusek-antonin.png?1752403674"},
  {id:31,name:"Sejk V√°clav",number:10,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/sejk-vaclav.png?1769590342"},
  {id:32,name:"Yasser Mohamed",number:35,pos:"√ö",img:"https://sigmafotbal.esports.cz/foto/2025_Fotky-hracu-A-25-26/yasser-mohamed.png?1758186725"}
].map(p=>({...p,img:p.img||getAvatar(p.name),posFull:fullPositions[p.pos]}));

const formations={
  '4-2-3-1':[{top:88,left:50},{top:70,left:15},{top:73,left:38},{top:73,left:62},{top:70,left:85},{top:56,left:35},{top:56,left:65},{top:38,left:20},{top:40,left:50},{top:38,left:80},{top:18,left:50}],
  '4-4-2':[{top:88,left:50},{top:70,left:15},{top:73,left:38},{top:73,left:62},{top:70,left:85},{top:48,left:18},{top:50,left:38},{top:50,left:62},{top:48,left:82},{top:22,left:35},{top:22,left:65}],
  '3-5-2':[{top:88,left:50},{top:72,left:25},{top:75,left:50},{top:72,left:75},{top:48,left:15},{top:52,left:35},{top:55,left:50},{top:52,left:65},{top:48,left:85},{top:22,left:35},{top:22,left:65}]
};

/* ============================================================
   STATE
   ============================================================ */
let allUsers={};
let allMatches={};
let allPredictions={};
let currentUser=null;
let currentMatchId=null;
let currentMatch=null;
let currentPrediction={formation:'4-2-3-1',lineup:new Array(11).fill(null),scorer:null,totalGoals:null,scoreHome:null,scoreAway:null,attendance:'',playerTips:{}};
function normalizeLineup(v){if(Array.isArray(v)) return v;const a=new Array(11).fill(null);if(v&&typeof v==='object') Object.keys(v).forEach(k=>{const i=parseInt(k);if(!isNaN(i)&&i>=0&&i<11) a[i]=v[k];});return a;}
let activeSlotIndex=null;
let modalContext='lineup';
let gamePhase='open'; // open | lineup_locked | all_locked | waiting | evaluated
let countdownInterval=null;
let adminFirstScorer=null;
let adminTotalGoals=null;
let adminGoalPlayers=new Set();
let adminAssistPlayers=new Set();
let modalStack=[];

/* ============================================================
   INIT
   ============================================================ */
window.onload=()=>{
  populateRegSelects();
  setupRegCityAutocomplete();
  buildGoalsGrid('goals-grid','user');
  buildGoalsGrid('admin-goals-grid','admin');
  setupAdminLists();

  // Listen to Firebase
  db.ref('users').on('value',snap=>{
    allUsers=snap.val()||{};
    updateHeroStats();
    if(currentUser){
      const me=allUsers[currentUser.id];
      if(me){currentUser.points=me.points||0;document.getElementById('user-top-pts').innerText=`${currentUser.points} b`;}
      renderLeaderboards();
      updateMyStats();
    }
  });

  db.ref('matches').on('value',snap=>{
    allMatches=snap.val()||{};
    pickCurrentMatch();
    if(currentUser) renderAdminMatchList();
  });

  db.ref('predictions').on('value',snap=>{
    allPredictions=snap.val()||{};
    if(currentUser&&currentMatchId) loadMyPrediction();
  });

  // Check auth
  const session=localStorage.getItem('sigma_session');
  if(session){
    const s=JSON.parse(session);
    // Verify in DB
    db.ref(`users/${s.id}`).once('value',snap=>{
      if(snap.exists()){
        currentUser={...snap.val(),id:s.id,isMe:true};
        localStorage.setItem('sigma_session',JSON.stringify(currentUser));
        showApp();
      }else{
        localStorage.removeItem('sigma_session');
        showHero();
      }
      hideLoading();
    });
  }else{
    showHero();
    hideLoading();
  }
};

function hideLoading(){document.getElementById('loading-overlay').classList.add('hidden');}
function showHero(){
  document.getElementById('section-hero').style.display='flex';
  document.getElementById('section-auth').style.display='none';
  document.getElementById('section-app').classList.remove('active');
  document.getElementById('section-app').style.display='none';
}
function showApp(){
  document.getElementById('section-hero').style.display='none';
  document.getElementById('section-auth').style.display='none';
  const app=document.getElementById('section-app');
  app.style.display='block';
  void app.offsetWidth;
  app.classList.add('active');
  setupMainApp();
}

function updateHeroStats(){document.getElementById('hero-users-count').textContent=Object.keys(allUsers).length;document.getElementById('hero-players-count').textContent=players.length;}

/* ============================================================
   AUTH
   ============================================================ */
function openAuth(tab){
  document.getElementById('section-hero').style.display='none';
  document.getElementById('section-auth').style.display='flex';
  switchAuthTab(tab);
  window.scrollTo({top:0});
}
function switchAuthTab(tab){
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  document.getElementById(`form-${tab}`).classList.add('active');
}
function backToHero(){document.getElementById('section-auth').style.display='none';document.getElementById('section-hero').style.display='flex';window.scrollTo({top:0});}

function populateRegSelects(){
  // nahrazeno mod√°lem s fotkami (openRegPlayerSelect)
}

const cityAddressFields=['city','town','village','municipality','hamlet'];

function setupRegCityAutocomplete(){
  const input=document.getElementById('reg-city');
  const list=document.getElementById('reg-city-list');
  if(!input||!list) return;
  const debounceDelay=400;
  const minInterval=1000;
  let timeoutId=null;
  let errorShown=false;
  let lastFetchAt=0;
  const runFetch=(query)=>{
    if(input.value.trim()!==query) return;
    lastFetchAt=Date.now();
    fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=6&accept-language=cs&countrycodes=cz&addressdetails=1&q=${encodeURIComponent(query)}`,{
      headers:{
        'Accept-Language':'cs',
        'User-Agent':'Sigma Fantasy (contact: info@sigmafantasy.cz)'
      }
    })
      .then(res=>{
        if(!res.ok) throw new Error(`Autocomplete request failed (${res.status})`);
        return res.json();
      })
      .then(data=>{
        if(input.value.trim()!==query) return;
        errorShown=false;
        list.innerHTML='';
        const seen=new Set();
        data.forEach(item=>{
          const address=item.address||{};
          const matchedCityField=cityAddressFields.find((key)=>address[key]);
          const cityName=matchedCityField?address[matchedCityField]:'';
          const normalizedCity=cityName.trim();
          if(!normalizedCity||seen.has(normalizedCity)) return;
          seen.add(normalizedCity);
          const option=document.createElement('option');
          option.value=normalizedCity;
          list.appendChild(option);
        });
      })
      .catch(()=>{
        list.innerHTML='';
        if(!errorShown){
          showToast("Na≈°ept√°vaƒç adres nen√≠ dostupn√Ω, zadejte mƒõsto ruƒçnƒõ","error");
          errorShown=true;
        }
      });
  };
  input.addEventListener('input',()=>{
    const query=input.value.trim();
    if(timeoutId) clearTimeout(timeoutId);
    if(query.length<3){list.innerHTML='';return;}
    timeoutId=setTimeout(()=>{
      const wait=minInterval-(Date.now()-lastFetchAt);
      if(wait>0){
        timeoutId=setTimeout(()=>runFetch(query),wait);
      }else{
        runFetch(query);
      }
    },debounceDelay);
  });
}

function registerUser(){
  const name=document.getElementById('reg-name').value.trim();
  const pin=document.getElementById('reg-pin').value;
  const emailInput=document.getElementById('reg-email');
  const email=emailInput.value.trim();
  const city=document.getElementById('reg-city').value.trim();
  const fav=document.getElementById('reg-player').value;
  if(!name||!pin||!email||!city||!fav){showToast("Vypl≈à v≈°echny √∫daje vƒçetnƒõ e-mailu","error");return;}
  if(!emailInput.checkValidity()){showToast("Zadej platn√Ω email","error");return;}
  if(pin.length<4){showToast("PIN min 4 znaky","error");return;}

  // Check name unique
  const names=Object.values(allUsers).map(u=>u.name.toLowerCase());
  if(names.includes(name.toLowerCase())){showToast("P≈ôezd√≠vka existuje","error");return;}

  const id='u_'+Date.now();
  const userData={name,pin,email,city,favPlayer:fav,points:0,createdAt:Date.now()};
  db.ref(`users/${id}`).set(userData).then(()=>{
    currentUser={...userData,id,isMe:true};
    localStorage.setItem('sigma_session',JSON.stringify(currentUser));
    showToast(`V√≠tej, ${name}! ‚öΩ`,"success");
    showApp();
  });
}

function loginUser(){
  const name=document.getElementById('login-name').value.trim();
  const pin=document.getElementById('login-pin').value;
  if(!name||!pin){showToast("Zadej p≈ôezd√≠vku i PIN","error");return;}

  const found=Object.entries(allUsers).find(([id,u])=>u.name.toLowerCase()===name.toLowerCase()&&u.pin===pin);
  if(found){
    const [id,u]=found;
    currentUser={...u,id,isMe:true};
    localStorage.setItem('sigma_session',JSON.stringify(currentUser));
    showToast(`V√≠tej, ${u.name}! ‚öΩ`,"success");
    showApp();
  }else showToast("≈†patn√° p≈ôezd√≠vka nebo PIN","error");
}

function logoutUser(){
  localStorage.clear();
  sessionStorage.clear();
  currentUser=null;
  if(countdownInterval) clearInterval(countdownInterval);
  closeModal('profile-modal');
  currentPrediction={formation:'4-2-3-1',lineup:new Array(11).fill(null),scorer:null,totalGoals:null,scoreHome:null,scoreAway:null,attendance:'',playerTips:{}};
  showToast("Odhl√°≈°eno","info");
  setTimeout(showHero,400);
}

/* ============================================================
   MAIN APP
   ============================================================ */
function setupMainApp(){
  document.getElementById('user-welcome').innerText=`V√≠tej, ${currentUser.name} üëã`;
  document.getElementById('user-top-pts').innerText=`${currentUser.points||0} b`;
  document.getElementById('user-top-avatar').src=getAvatar(currentUser.name);

  pickCurrentMatch();
  initPitchDOM();
  updatePitchPositions();
  renderLeaderboards();
  updateMyStats();
  renderAdminMatchList();

  if(currentUser.name.toLowerCase()==='dohnos') document.getElementById('admin-panel').style.display='block';
  else document.getElementById('admin-panel').style.display='none';

  startCountdown();
}

/* ============================================================
   MATCH PICKING
   ============================================================ */
function pickCurrentMatch(){
  const now=Date.now();
  let best=null;
  Object.entries(allMatches).forEach(([id,m])=>{
    if(m.status==='evaluated') return;
    if(!best||m.datetime<best.datetime) best={...m,id};
  });

  // If no upcoming, get last evaluated
  if(!best){
    Object.entries(allMatches).forEach(([id,m])=>{
      if(m.status==='evaluated'){if(!best||m.datetime>best.datetime) best={...m,id};}
    });
  }

  if(best){
    currentMatchId=best.id;
    currentMatch=best;
    updateMatchWidget();
    loadMyPrediction();
    if(currentUser) ensurePredictionEntry();
  }else{
    currentMatchId=null;
    currentMatch=null;
    document.getElementById('away-name').textContent='???';
    document.getElementById('away-logo').textContent='?';
  }
}

function updateMatchWidget(){
  if(!currentMatch) return;
  document.getElementById('away-name').textContent=currentMatch.opponent||'???';
  document.getElementById('away-logo').textContent=currentMatch.logo||'?';
  document.getElementById('match-league-text').textContent=`Chance Liga ‚Äî ${currentMatch.round||''}`;
  document.getElementById('pred-away-label').textContent=currentMatch.opponent||'Soupe≈ô';

  updatePhase();
  updateCountdown();
}

/* ============================================================
   PHASES
   ============================================================ */
function updatePhase(){
  if(!currentMatch){gamePhase='open';return;}
  const now=Date.now();
  const mt=currentMatch.datetime;

  if(currentMatch.status==='evaluated'){
    gamePhase='evaluated';
  }else if(currentMatch.status==='waiting'){
    gamePhase='waiting';
  }else if(now>=mt){
    gamePhase='waiting';
    // Auto-set to waiting in DB
    db.ref(`matches/${currentMatchId}/status`).set('waiting');
  }else if(now>=mt-3600000){
    gamePhase='all_locked';
  }else if(now>=mt-7200000){
    gamePhase='lineup_locked';
  }else{
    gamePhase='open';
  }

  updatePhaseUI();
}

function updatePhaseUI(){
  const banner=document.getElementById('phase-banner');
  const statusBar=document.getElementById('match-status-bar');
  const evalCard=document.getElementById('eval-card');
  const formTabs=document.getElementById('formation-tabs');
  const predCard=document.getElementById('prediction-card');

  banner.className='phase-banner';
  let pills='';

  switch(gamePhase){
    case 'open':
      banner.classList.add('phase-open');
      banner.innerHTML='<i class="fa-solid fa-lock-open"></i><span>V≈°e otev≈ôeno ‚Äî sestavuj a tipuj!</span>';
      pills='<div class="status-pill open"><span class="status-dot green"></span> Sestavy otev≈ôeny</div><div class="status-pill open"><span class="status-dot green"></span> Tipy otev≈ôeny</div>';
      enableFormTabs(true);enablePredictions(true);enableLineup(true);
      evalCard.classList.remove('show');
      break;
    case 'lineup_locked':
      banner.classList.add('phase-lineup-locked');
      banner.innerHTML='<i class="fa-solid fa-lock"></i><span>Sestavy uzamƒçeny! Tipy lze mƒõnit do 1h p≈ôed z√°pasem.</span>';
      pills='<div class="status-pill locked"><span class="status-dot red"></span> Sestavy uzamƒçeny</div><div class="status-pill open"><span class="status-dot green"></span> Tipy otev≈ôeny</div>';
      enableFormTabs(false);enablePredictions(true);enableLineup(false);
      evalCard.classList.remove('show');
      break;
    case 'all_locked':
      banner.classList.add('phase-all-locked');
      banner.innerHTML='<i class="fa-solid fa-lock"></i><span>V≈°e uzamƒçeno! ƒåekej na z√°pas.</span>';
      pills='<div class="status-pill locked"><span class="status-dot red"></span> V≈°e uzamƒçeno</div>';
      enableFormTabs(false);enablePredictions(false);enableLineup(false);
      evalCard.classList.remove('show');
      break;
    case 'waiting':
      banner.classList.add('phase-waiting');
      banner.innerHTML='<i class="fa-solid fa-hourglass-half"></i><span>Z√°pas probƒõhl ‚Äî ƒçek√° se na vyhodnocen√≠ adminem.</span>';
      pills='<div class="status-pill waiting"><span class="status-dot yellow"></span> ƒåek√° na vyhodnocen√≠</div>';
      enableFormTabs(false);enablePredictions(false);enableLineup(false);
      evalCard.classList.remove('show');
      break;
    case 'evaluated':
      banner.classList.add('phase-evaluated');
      banner.innerHTML='<i class="fa-solid fa-check-circle"></i><span>Z√°pas vyhodnocen! Pod√≠vej se na sv√© body.</span>';
      pills='<div class="status-pill" style="background:#eff6ff;color:var(--primary);border:1px solid #bfdbfe"><span>‚úÖ Vyhodnoceno</span></div>';
      enableFormTabs(false);enablePredictions(false);enableLineup(false);
      showEvaluation();
      break;
  }
  statusBar.innerHTML=pills;
}

function enableFormTabs(en){document.querySelectorAll('#formation-tabs .form-btn').forEach(b=>{b.disabled=!en;});}
function enablePredictions(en){
  document.querySelectorAll('#score-predictor input').forEach(i=>i.disabled=!en);
  document.getElementById('btn-scorer-select').classList.toggle('disabled',!en);
  document.querySelectorAll('#goals-grid .goal-chip').forEach(c=>c.classList.toggle('disabled',!en));
  document.getElementById('attendance').disabled=!en;
  const isAdmin=currentUser&&currentUser.name.toLowerCase()==='dohnos';
  document.getElementById('btn-save-pred').style.display=(en&&isAdmin)?'flex':'none';
}
function enableLineup(en){
  for(let i=0;i<11;i++){
    const s=document.getElementById(`slot-${i}`);if(!s) continue;
    if(en){s.classList.remove('disabled');}
    else{
      const pid=currentPrediction.lineup[i];
      const interactive=(gamePhase==='lineup_locked'&&pid);
      s.classList.toggle('disabled',!interactive);
    }
  }
}

/* ============================================================
   COUNTDOWN
   ============================================================ */
function startCountdown(){if(countdownInterval) clearInterval(countdownInterval);countdownInterval=setInterval(updateCountdown,1000);updateCountdown();}

function updateCountdown(){
  if(!currentMatch){return;}
  const now=Date.now();
  const mt=currentMatch.datetime;
  const diff=mt-now;

  if(diff<=0){
    document.getElementById('cd-days').textContent='0';
    document.getElementById('cd-hours').textContent='0';
    document.getElementById('cd-mins').textContent='0';
    document.getElementById('cd-secs').textContent='00';
    document.getElementById('countdown-label').textContent=gamePhase==='evaluated'?'Z√°pas odehr√°n':'Z√°pas prob√≠h√° / skonƒçil';
  }else{
    document.getElementById('cd-days').textContent=Math.floor(diff/86400000);
    document.getElementById('cd-hours').textContent=Math.floor((diff%86400000)/3600000);
    document.getElementById('cd-mins').textContent=Math.floor((diff%3600000)/60000);
    document.getElementById('cd-secs').textContent=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    document.getElementById('countdown-label').textContent='Do zaƒç√°tku z√°pasu';
  }
  updatePhase();
}

/* ============================================================
   GOALS GRID
   ============================================================ */
function buildGoalsGrid(containerId,type){
  const c=document.getElementById(containerId);if(!c) return;
  c.innerHTML='';
  for(let i=0;i<=10;i++){
    const chip=document.createElement('div');
    chip.className='goal-chip';
    chip.textContent=i;
    chip.dataset.value=i;
    chip.onclick=()=>{
      if(chip.classList.contains('disabled')) return;
      c.querySelectorAll('.goal-chip').forEach(x=>x.classList.remove('active'));
      chip.classList.add('active');
      if(type==='user'){currentPrediction.totalGoals=i;autoSave();}
      else adminTotalGoals=i;
    };
    c.appendChild(chip);
  }
}

/* ============================================================
   PITCH
   ============================================================ */
function initPitchDOM(){
  const pitch=document.getElementById('pitch');
  const dec=['pitch-center-dot','penalty-box-top','penalty-box-bottom','goal-box-top','goal-box-bottom'];
  const saved=[];
  dec.forEach(cls=>{const el=pitch.querySelector(`.${cls}`);if(el) saved.push(el);});
  pitch.innerHTML='';
  saved.forEach(el=>pitch.appendChild(el));
  for(let i=0;i<11;i++){
    const slot=document.createElement('div');
    slot.id=`slot-${i}`;
    slot.onclick=()=>handleSlotClick(i);
    pitch.appendChild(slot);
  }
  renderPlayersInSlots();
}

function updatePitchPositions(){
  const coords=formations[currentPrediction.formation];
  for(let i=0;i<11;i++){
    const s=document.getElementById(`slot-${i}`);
    if(s&&coords[i]){s.style.top=`${coords[i].top}%`;s.style.left=`${coords[i].left}%`;}
  }
}

function changeFormation(f){
  if(gamePhase!=='open'){showToast("Sestavy jsou uzamƒçeny","error");return;}
  currentPrediction.formation=f;
  document.querySelectorAll('#formation-tabs .form-btn').forEach(b=>b.classList.toggle('active',b.innerText===f));
  updatePitchPositions();
  autoSave();
}

function handleSlotClick(i){
  const pid=currentPrediction.lineup[i];
  if(pid){
    if(gamePhase!=='open'&&gamePhase!=='lineup_locked') return;
    activeSlotIndex=i;
    const p=players.find(x=>x.id==pid);if(!p) return;
    document.getElementById('action-player-img').src=p.img;
    document.getElementById('action-player-name').innerText=p.name;
    document.getElementById('action-player-pos').innerText=p.posFull;
    document.getElementById('btn-remove-player').style.display=(gamePhase==='open')?'flex':'none';
    openModal('action-modal');
  }else{
    if(gamePhase!=='open'){showToast("Sestavy jsou uzamƒçeny","error");return;}
    activeSlotIndex=i;modalContext='lineup';openSelectionModal();
  }
}

function shouldDisableSlot(pid){
  const isOpen=gamePhase==='open';
  const isLockedWithPlayer=gamePhase==='lineup_locked'&&pid;
  return !isOpen&&!isLockedWithPlayer;
}

function renderPlayersInSlots(){
  for(let i=0;i<11;i++){
    const s=document.getElementById(`slot-${i}`);if(!s) continue;
    const pid=currentPrediction.lineup[i];
    s.className='slot';
    if(shouldDisableSlot(pid)) s.classList.add('disabled');

    if(pid){
      const p=players.find(x=>x.id==pid);if(!p) continue;
      const tip=currentPrediction.playerTips[pid];
      let badge='';
      if(tip==='goal') badge='<div class="tip-badge">‚öΩ</div>';
      else if(tip==='assist') badge='<div class="tip-badge">üëü</div>';
      s.classList.add('filled');
      s.innerHTML=`${badge}<img src="${p.img}"><div class="player-name-tag">${p.name}</div>`;
    }else{
      s.classList.add('empty');
      s.innerHTML=i===0?'<i class="fa-solid fa-hand fa-lg"></i>':'<i class="fa-solid fa-plus fa-lg"></i>';
    }
  }
}

/* ============================================================
   SELECTION MODALS
   ============================================================ */
function openSelectionModal(){
  const list=document.getElementById('player-list');list.innerHTML='';
  const isScorer=(modalContext==='scorer');
  const isGK=(modalContext==='lineup'&&activeSlotIndex===0);
  document.getElementById('modal-title').innerHTML=isScorer?'üéØ Vyber st≈ôelce':(isGK?'üß§ Vyber brank√°≈ôe':'üë§ Vyber hr√°ƒçe');

  const sorted=[...players].sort((a,b)=>{const o={B:0,O:1,Z:2,√ö:3};return(o[a.pos]||0)-(o[b.pos]||0)||a.name.localeCompare(b.name);});
  sorted.forEach(p=>{
    if(isScorer&&p.pos==='B') return;
    if(modalContext==='lineup'){if(isGK&&p.pos!=='B') return;if(!isGK&&p.pos==='B') return;}
    const inLineup=currentPrediction.lineup.includes(p.id)&&currentPrediction.lineup[activeSlotIndex]!==p.id;
    const disabled=(modalContext==='lineup'&&inLineup);
    const div=document.createElement('div');
    div.className=`player-item${disabled?' selected':''}`;
    div.innerHTML=`<img src="${p.img}"><div class="player-info-container"><span class="player-name">${p.name}</span><span class="player-pos-full">${p.posFull}</span></div>${disabled?'<i class="fa-solid fa-check" style="color:var(--success)"></i>':'<i class="fa-solid fa-chevron-right" style="color:#cbd5e1"></i>'}`;
    if(!disabled){
      div.onclick=()=>{
        if(modalContext==='lineup'){
          currentPrediction.lineup[activeSlotIndex]=p.id;renderPlayersInSlots();showToast(`${p.name} p≈ôid√°n`,"success");autoSave();
        }else{
          currentPrediction.scorer=p.id;updateVisualScorerBtn();showToast(`Tip: ${p.name}`,"success");autoSave();
        }
        closeModal('player-modal');
      };
    }
    list.appendChild(div);
  });
  openModal('player-modal');
}

function setPlayerTip(type){
  const pid=currentPrediction.lineup[activeSlotIndex];
  if(!pid) return;
  const currentType=currentPrediction.playerTips[pid];
  if(type&&type!==currentType){
    const tipEntries=Object.entries(currentPrediction.playerTips||{});
    const currentPlayerId=String(pid);
    const existingTipCount=tipEntries.filter(([id,t])=>t===type&&id!==currentPlayerId).length;
    if(existingTipCount>=2){
      showToast(`Tip na ${type==='goal'?'g√≥l':'asistenci'} m≈Ø≈æe≈° d√°t pouze 2 hr√°ƒç≈Øm`,"error");
      return;
    }
  }
  if(type===null) delete currentPrediction.playerTips[pid];else currentPrediction.playerTips[pid]=type;
  closeModal('action-modal');renderPlayersInSlots();showToast(type?`Tip: ${type==='goal'?'g√≥l':'asistence'}`:"Tip zru≈°en","success");autoSave();
}
function removePlayerFromPitch(){
  if(gamePhase!=='open'){showToast("Uzamƒçeno","error");return;}
  const pid=currentPrediction.lineup[activeSlotIndex];
  if(pid) delete currentPrediction.playerTips[pid];
  currentPrediction.lineup[activeSlotIndex]=null;
  closeModal('action-modal');renderPlayersInSlots();autoSave();
}
function openScorerSelectModal(){
  if(gamePhase==='all_locked'||gamePhase==='waiting'||gamePhase==='evaluated'){showToast("Tipy uzamƒçeny","error");return;}
  modalContext='scorer';activeSlotIndex=null;openSelectionModal();
}
function updateVisualScorerBtn(){
  const btn=document.getElementById('btn-scorer-select');
  if(currentPrediction.scorer){
    const p=players.find(x=>x.id==currentPrediction.scorer);
    if(p) btn.innerHTML=`<img src="${p.img}"><div class="vs-text">${p.name}</div><span class="vs-pos">${p.posFull}</span>`;
  }else btn.innerHTML=`<div class="icon-placeholder"><i class="fa-solid fa-crosshairs"></i></div><div class="vs-text" style="color:var(--text-muted)">Vyber st≈ôelce...</div>`;
}

/* ============================================================
   SAVE / LOAD PREDICTION (Firebase)
   ============================================================ */
function savePrediction(){
  if(!currentMatchId){showToast("≈Ω√°dn√Ω aktivn√≠ z√°pas","error");return;}
  currentPrediction.scoreHome=parseInt(document.getElementById('pred-score-home').value);
  currentPrediction.scoreAway=parseInt(document.getElementById('pred-score-away').value);
  currentPrediction.attendance=document.getElementById('attendance').value;

  const filled=currentPrediction.lineup.filter(Boolean).length;
  if(filled<11){showToast(`Sestava ${filled}/11`,"error");return;}
  if(!currentPrediction.scorer){showToast("Vyber st≈ôelce","error");return;}
  if(currentPrediction.totalGoals===null){showToast("Vyber poƒçet g√≥l≈Ø","error");return;}
  if(isNaN(currentPrediction.scoreHome)||isNaN(currentPrediction.scoreAway)){showToast("Zadej v√Ωsledek","error");return;}

  const data={...currentPrediction,savedAt:Date.now()};
  db.ref(`predictions/${currentMatchId}/${currentUser.id}`).set(data).then(()=>{
    showToast("Predikce ulo≈æena! ‚úÖ","success");
    updateMyStats();
  }).catch(e=>showToast("Chyba: "+e.message,"error"));
}

let autosaveTimer=null;
function parseOptionalInt(value){
  if(value==null||value==='') return null;
  const parsed=parseInt(value,10);
  return Number.isFinite(parsed)?parsed:null;
}
function autoSave(){
  if(!currentMatchId||!currentUser) return;
  if(gamePhase==='all_locked'||gamePhase==='waiting'||gamePhase==='evaluated') return;
  clearTimeout(autosaveTimer);
  autosaveTimer=setTimeout(()=>{
    currentPrediction.scoreHome=parseOptionalInt(document.getElementById('pred-score-home').value);
    currentPrediction.scoreAway=parseOptionalInt(document.getElementById('pred-score-away').value);
    currentPrediction.attendance=document.getElementById('attendance').value;
    const data={...currentPrediction,savedAt:Date.now()};
    db.ref(`predictions/${currentMatchId}/${currentUser.id}`).set(data).then(()=>{
      showToast("Automaticky ulo≈æeno ‚úÖ","success");
      updateMyStats();
    }).catch(e=>showToast("Chyba: "+e.message,"error"));
  },1500);
}

function loadMyPrediction(){
  if(!currentMatchId||!currentUser) return;
  const pred=(allPredictions[currentMatchId]||{})[currentUser.id];
  if(pred){
    currentPrediction={...currentPrediction,...pred};
    currentPrediction.lineup=normalizeLineup(currentPrediction.lineup);
    if(!currentPrediction.playerTips||typeof currentPrediction.playerTips!=='object') currentPrediction.playerTips={};
    if(pred.scoreHome!=null) document.getElementById('pred-score-home').value=pred.scoreHome;
    if(pred.scoreAway!=null) document.getElementById('pred-score-away').value=pred.scoreAway;
    document.getElementById('attendance').value=pred.attendance||'';
    if(pred.totalGoals!=null){
      document.querySelectorAll('#goals-grid .goal-chip').forEach(c=>{c.classList.toggle('active',parseInt(c.dataset.value)===pred.totalGoals);});
    }
    updateVisualScorerBtn();
    renderPlayersInSlots();
    updatePitchPositions();
    document.querySelectorAll('#formation-tabs .form-btn').forEach(b=>b.classList.toggle('active',b.innerText===currentPrediction.formation));
  }
}

function ensurePredictionEntry(){
  if(!currentMatchId||!currentUser) return;
  db.ref(`predictions/${currentMatchId}/${currentUser.id}`).once('value',snap=>{
    if(snap.exists()) return;
    const scoreHome=parseOptionalInt(currentPrediction.scoreHome);
    const scoreAway=parseOptionalInt(currentPrediction.scoreAway);
    const data={...currentPrediction,scoreHome,scoreAway,savedAt:Date.now()};
    db.ref(`predictions/${currentMatchId}/${currentUser.id}`).set(data).catch(e=>console.warn("Prediction seed failed",{matchId:currentMatchId,error:e}));
  });
}

/* ============================================================
   EVALUATION DISPLAY
   ============================================================ */
function showEvaluation(){
  const evalCard=document.getElementById('eval-card');
  const hasEvaluationData=!!(currentMatch&&currentMatch.results&&currentUser&&currentUser.id);
  if(!hasEvaluationData){evalCard.classList.remove('show');return;}
  const preds=(allPredictions[currentMatchId]||{})[currentUser.id];
  if(!preds){evalCard.classList.remove('show');return;}

  const r=currentMatch.results;
  let total=0;const rows=[];

  const predsLineup=normalizeLineup(preds.lineup);
  if(predsLineup.filter(Boolean).length===11){total+=1;rows.push(['Kompletn√≠ sestava','+1']);}

  if(preds.scoreHome==r.scoreHome&&preds.scoreAway==r.scoreAway){total+=10;rows.push(['P≈ôesn√© sk√≥re','+10']);}
  else{
    const o=Math.sign(r.scoreHome-r.scoreAway);
    const uo=Math.sign((preds.scoreHome||0)-(preds.scoreAway||0));
    if(o===uo){total+=3;rows.push(['Spr√°vn√Ω tip V/R/P','+3']);}
  }
  if(preds.scorer==r.firstScorer){total+=5;rows.push(['St≈ôelec 1. g√≥lu','+5']);}
  if(preds.totalGoals!=null&&preds.totalGoals==r.totalGoals){total+=3;rows.push(['Celkov√© g√≥ly','+3']);}
  if(preds.attendance&&r.attendance){
    if(parseInt(preds.attendance)==r.attendance){total+=5;rows.push(['P≈ôesn√° n√°v≈°tƒõvnost','+5']);}
    else if(Math.abs(parseInt(preds.attendance)-r.attendance)<=1000){total+=2;rows.push(['N√°v≈°tƒõvnost ¬±1000','+2']);}
  }
  Object.entries(preds.playerTips||{}).forEach(([pid,type])=>{
    const id=parseInt(pid);const p=players.find(x=>x.id===id);
    if(type==='goal'&&(r.goalScorers||[]).includes(id)){total+=4;rows.push([`${p?p.name:'?'} ‚Äì g√≥l`,'+4']);}
    if(type==='assist'&&(r.assistPlayers||[]).includes(id)){total+=3;rows.push([`${p?p.name:'?'} ‚Äì asistence`,'+3']);}
  });

  document.getElementById('eval-total-pts').textContent=`+${total}`;
  document.getElementById('eval-breakdown').innerHTML=rows.map(([label,pts])=>`<div class="eval-row"><span>${label}</span><span class="pts">${pts}</span></div>`).join('');
  evalCard.classList.add('show');
}

/* ============================================================
   ADMIN ‚Äî MATCHES
   ============================================================ */
function adminAddMatch(){
  const opp=document.getElementById('admin-new-opponent').value.trim();
  const logo=document.getElementById('admin-new-logo').value.trim()||opp.charAt(0);
  const round=document.getElementById('admin-new-round').value.trim();
  const dt=document.getElementById('admin-new-datetime').value;
  if(!opp||!dt){showToast("Vypl≈à soupe≈ôe a datum","error");return;}

  const id='m_'+Date.now();
  db.ref(`matches/${id}`).set({
    opponent:opp,logo,round,
    datetime:new Date(dt).getTime(),
    status:'upcoming',
    createdAt:Date.now()
  }).then(()=>{
    showToast("Z√°pas p≈ôid√°n","success");
    document.getElementById('admin-new-opponent').value='';
    document.getElementById('admin-new-logo').value='';
    document.getElementById('admin-new-round').value='';
    document.getElementById('admin-new-datetime').value='';
  });
}

function renderAdminMatchList(){
  const c=document.getElementById('admin-match-list');if(!c) return;
  const sorted=Object.entries(allMatches).sort(([,a],[,b])=>a.datetime-b.datetime);
  c.innerHTML=sorted.map(([id,m])=>{
    const d=new Date(m.datetime);
    const status=m.status==='evaluated'?'‚úÖ':(m.status==='waiting'?'‚è≥':'üìÖ');
    return `<div class="admin-match-item"><div style="font-size:1.2rem">${status}</div><div style="flex:1"><div class="match-text">Sigma vs ${m.opponent}</div><div class="match-meta">${d.toLocaleString('cs-CZ')} ¬∑ ${m.round||''}</div></div><div class="admin-match-actions"><button class="btn-sm-danger" onclick="adminDeleteMatch('${id}')"><i class="fa-solid fa-trash"></i></button></div></div>`;
  }).join('');
}

function adminDeleteMatch(id){
  if(!confirm('Smazat z√°pas?')) return;
  db.ref(`matches/${id}`).remove();
  db.ref(`predictions/${id}`).remove();
  showToast("Smaz√°no","info");
}

/* ============================================================
   ADMIN ‚Äî EVALUATE
   ============================================================ */
function setupAdminLists(){
  ['admin-goal-list','admin-assist-list'].forEach((containerId,ci)=>{
    const c=document.getElementById(containerId);if(!c) return;
    c.innerHTML='';
    players.forEach(p=>{
      const btn=document.createElement('button');
      btn.className='btn-outline';btn.innerText=p.name;btn.style.flex='0 0 auto';btn.style.width='auto';btn.style.padding='8px 12px';btn.style.fontSize='.78rem';
      btn.onclick=()=>{
        const set=ci===0?adminGoalPlayers:adminAssistPlayers;
        if(set.has(p.id)){set.delete(p.id);btn.style.background='transparent';btn.style.borderColor='#e2e8f0';btn.style.color='';}
        else{set.add(p.id);btn.style.background='#dcfce7';btn.style.borderColor='#86efac';btn.style.color='#065f46';}
      };
      c.appendChild(btn);
    });
  });
}

function openRegPlayerSelect(){
  modalContext='regPlayer';
  const list=document.getElementById('player-list');
  list.innerHTML='';
  document.getElementById('modal-title').innerHTML='‚≠ê Obl√≠ben√Ω hr√°ƒç';
  [...players].sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const div=document.createElement('div');
    div.className='player-item';
    div.innerHTML=`<img src="${p.img}"><div class="player-info-container"><span class="player-name">${p.name}</span><span class="player-pos-full">${p.posFull}</span></div>`;
    div.onclick=()=>{
      document.getElementById('reg-player').value=p.name;
      document.getElementById('reg-player-label').textContent=p.name;
      document.getElementById('reg-player-label').style.color='var(--text-main)';
      const img=document.getElementById('reg-player-img');
      img.src=p.img;
      img.alt=`Obl√≠ben√Ω hr√°ƒç: ${p.name}`;
      img.style.display='block';
      closeModal('player-modal');
    };
    list.appendChild(div);
  });
  openModal('player-modal');
}

function openAdminScorerSelect(){
  modalContext='adminScorer';
  const list=document.getElementById('player-list');list.innerHTML='';
  document.getElementById('modal-title').innerHTML='üéØ Prvn√≠ st≈ôelec';
  players.filter(p=>p.pos!=='B').forEach(p=>{
    const div=document.createElement('div');
    div.className='player-item';
    div.innerHTML=`<img src="${p.img}"><div class="player-info-container"><span class="player-name">${p.name}</span><span class="player-pos-full">${p.posFull}</span></div>`;
    div.onclick=()=>{adminFirstScorer=p.id;document.getElementById('admin-scorer-label').innerText=p.name;document.getElementById('admin-scorer-label').style.color='var(--text-main)';closeModal('player-modal');};
    list.appendChild(div);
  });
  openModal('player-modal');
}

function evaluateMatch(){
  if(!currentMatchId){showToast("≈Ω√°dn√Ω z√°pas","error");return;}
  const sh=parseInt(document.getElementById('admin-score-home').value);
  const sa=parseInt(document.getElementById('admin-score-away').value);
  const att=parseInt(document.getElementById('admin-attendance').value)||0;
  if(isNaN(sh)||isNaN(sa)){showToast("Zadej sk√≥re","error");return;}

  const results={
    scoreHome:sh,scoreAway:sa,
    firstScorer:adminFirstScorer,
    totalGoals:adminTotalGoals,
    attendance:att,
    goalScorers:[...adminGoalPlayers],
    assistPlayers:[...adminAssistPlayers]
  };

  // Calculate points for each user
  const matchPreds=allPredictions[currentMatchId]||{};
  const updates={};

  Object.entries(matchPreds).forEach(([uid,pred])=>{
    let pts=0;
    if(normalizeLineup(pred.lineup).filter(Boolean).length===11) pts+=1;
    if(pred.scoreHome==sh&&pred.scoreAway==sa) pts+=10;
    else{const o=Math.sign(sh-sa);const uo=Math.sign((pred.scoreHome||0)-(pred.scoreAway||0));if(o===uo) pts+=3;}
    if(pred.scorer==adminFirstScorer) pts+=5;
    if(pred.totalGoals!=null&&pred.totalGoals==adminTotalGoals) pts+=3;
    if(pred.attendance&&att){if(parseInt(pred.attendance)==att) pts+=5;else if(Math.abs(parseInt(pred.attendance)-att)<=1000) pts+=2;}
    Object.entries(pred.playerTips||{}).forEach(([pid,type])=>{
      const id=parseInt(pid);
      if(type==='goal'&&adminGoalPlayers.has(id)) pts+=4;
      if(type==='assist'&&adminAssistPlayers.has(id)) pts+=3;
    });

    const curPts=(allUsers[uid]||{}).points||0;
    updates[`users/${uid}/points`]=curPts+pts;
    updates[`predictions/${currentMatchId}/${uid}/earnedPoints`]=pts;
  });

  updates[`matches/${currentMatchId}/status`]='evaluated';
  updates[`matches/${currentMatchId}/results`]=results;

  db.ref().update(updates).then(()=>{
    showToast("Z√°pas vyhodnocen! Body p≈ôidƒõleny.","success");
    // Reset admin state
    adminFirstScorer=null;adminTotalGoals=null;adminGoalPlayers.clear();adminAssistPlayers.clear();
    document.getElementById('admin-scorer-label').innerText='Vyber hr√°ƒçe...';
    document.getElementById('admin-scorer-label').style.color='';
    document.querySelectorAll('#admin-goals-grid .goal-chip').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('#admin-goal-list button, #admin-assist-list button').forEach(b=>{b.style.background='';b.style.borderColor='';b.style.color='';});
  }).catch(e=>showToast("Chyba: "+e.message,"error"));
}

/* ============================================================
   LEADERBOARD
   ============================================================ */
function renderLeaderboards(){
  const users=Object.entries(allUsers).map(([id,u])=>({...u,id})).sort((a,b)=>(b.points||0)-(a.points||0));
  const c=document.getElementById('leaderboard-container');
  const f=document.getElementById('full-lb-list');
  c.innerHTML=users.slice(0,5).map((u,i)=>lbItem(u,i)).join('');
  if(f) f.innerHTML=users.map((u,i)=>lbItem(u,i)).join('');
}

function lbItem(u,i){
  const isMe=currentUser&&u.id===currentUser.id;
  const medal=i===0?'ü•á':(i===1?'ü•à':(i===2?'ü•â':`${i+1}.`));
  const rc=i===0?'gold':(i===1?'silver':(i===2?'bronze':''));
  return `<div class="lb-item${isMe?' is-me':''}" onclick="openProfile('${u.id}')"><div class="lb-rank ${rc}">${medal}</div><img src="${getAvatar(u.name)}"><div class="lb-name">${u.name}${isMe?' <span style="font-size:.7rem;color:var(--primary)">(ty)</span>':''}</div><div class="lb-pts">${u.points||0} b</div></div>`;
}

function openFullLeaderboard(){renderLeaderboards();openModal('full-lb-modal');}

function updateMyStats(){
  if(!currentUser) return;
  const me=allUsers[currentUser.id];
  document.getElementById('my-points').textContent=me?me.points||0:0;
  const preds=allPredictions?Object.values(allPredictions).filter(mp=>mp[currentUser.id]).length:0;
  document.getElementById('my-predictions').textContent=preds;
  const users=Object.entries(allUsers).map(([id,u])=>({id,points:u.points||0})).sort((a,b)=>b.points-a.points);
  const rank=users.findIndex(u=>u.id===currentUser.id)+1;
  document.getElementById('my-rank').textContent=rank>0?`${rank}.`:'‚Äî';
  renderMatchHistory();
}

function renderMatchHistory(){
  const c=document.getElementById('match-history-container');if(!c||!currentUser) return;
  const items=[];
  Object.entries(allMatches).sort(([,a],[,b])=>b.datetime-a.datetime).forEach(([mid,m])=>{
    const pred=(allPredictions[mid]||{})[currentUser.id];
    if(!pred) return;
    const pts=pred.earnedPoints;
    const isEval=m.status==='evaluated';
    const r=m.results||{};
    const tags=[];
    if(isEval&&r.scoreHome!=null){
      if(normalizeLineup(pred.lineup).filter(Boolean).length===11) tags.push('Sestava +1');
      if(pred.scoreHome==r.scoreHome&&pred.scoreAway==r.scoreAway) tags.push('P≈ôesn√© sk√≥re +10');
      else{const o=Math.sign(r.scoreHome-r.scoreAway);const uo=Math.sign((pred.scoreHome||0)-(pred.scoreAway||0));if(o===uo) tags.push('Tip V/R/P +3');}
      if(pred.scorer==r.firstScorer) tags.push('1. st≈ôelec +5');
      if(pred.totalGoals!=null&&pred.totalGoals==r.totalGoals) tags.push('G√≥ly +3');
      if(pred.attendance&&r.attendance){if(parseInt(pred.attendance)==r.attendance) tags.push('N√°v≈°tƒõvnost +5');else if(Math.abs(parseInt(pred.attendance)-r.attendance)<=1000) tags.push('N√°v≈°tƒõvnost ¬±1000 +2');}
      Object.entries(pred.playerTips||{}).forEach(([pid,type])=>{
        const id=parseInt(pid);const p=players.find(x=>x.id===id);
        if(type==='goal'&&(r.goalScorers||[]).includes(id)) tags.push(`${p?p.name:'?'} g√≥l +4`);
        if(type==='assist'&&(r.assistPlayers||[]).includes(id)) tags.push(`${p?p.name:'?'} asist. +3`);
      });
    }
    const d=new Date(m.datetime);
    const dateStr=d.toLocaleDateString('cs-CZ',{day:'numeric',month:'short',year:'numeric'});
    items.push(`<div class="match-history-item"><div class="mh-header"><div><div class="mh-match">Sigma vs ${m.opponent||'?'}</div><div class="mh-round">${m.round||''} ¬∑ ${dateStr}</div></div>${isEval?`<div class="mh-pts${pts===0?' zero':''}">${pts!=null?'+'+pts:'‚Äî'}</div>`:'<div class="mh-pts zero">‚è≥</div>'}</div>${tags.length?'<div class="mh-breakdown">'+tags.map(t=>`<span class="mh-tag">${t}</span>`).join('')+'</div>':''}</div>`);
  });
  c.innerHTML=items.length?items.join(''):'<div class="mh-empty">Zat√≠m ≈æ√°dn√© tipy</div>';
}

function openProfile(id){
  if(id==='me') id=currentUser.id;
  const u=allUsers[id];if(!u) return;
  const users=Object.entries(allUsers).map(([uid,x])=>({uid,points:x.points||0})).sort((a,b)=>b.points-a.points);
  const rank=users.findIndex(x=>x.uid===id)+1;
  document.getElementById('prof-img').src=getAvatar(u.name);
  document.getElementById('prof-name').innerText=u.name;
  document.getElementById('prof-pts').innerText=`${u.points||0} bod≈Ø`;
  document.getElementById('prof-city').innerText=u.city||'‚Äî';
  document.getElementById('prof-fav').innerText=u.favPlayer||'‚Äî';
  document.getElementById('prof-rank').innerText=`${rank}. m√≠sto`;
  document.getElementById('btn-logout').style.display=(currentUser&&id===currentUser.id)?'inline-flex':'none';
  openModal('profile-modal');
}

/* ============================================================
   MODALS
   ============================================================ */
function openModal(id){
  const m=document.getElementById(id);if(!m) return;
  m.style.display='flex';
  modalStack.push(id);
  m.style.zIndex=1000+modalStack.length*10;
  requestAnimationFrame(()=>requestAnimationFrame(()=>m.classList.add('show')));
  m._bh=e=>{if(e.target===m) closeModal(id);};
  m.addEventListener('click',m._bh);
}
function closeModal(id){
  const m=document.getElementById(id);if(!m) return;
  m.classList.remove('show');
  if(m._bh){m.removeEventListener('click',m._bh);m._bh=null;}
  setTimeout(()=>{m.style.display='none';modalStack=modalStack.filter(x=>x!==id);},350);
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modalStack.length) closeModal(modalStack[modalStack.length-1]);});

/* ============================================================
   TOAST
   ============================================================ */
function showToast(msg,type='info'){
  const t=document.getElementById('toast');
  const icons={success:'fa-check-circle',error:'fa-triangle-exclamation',info:'fa-circle-info'};
  t.className=type+' show';
  t.innerHTML=`<i class="fa-solid ${icons[type]||'fa-bell'}"></i> <span>${msg}</span>`;
  setTimeout(()=>t.classList.remove('show'),3500);
}
</script>
</body>
</html>
